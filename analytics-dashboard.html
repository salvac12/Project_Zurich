<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analytics - Project ZURICH | Alter5</title>
    <link rel="stylesheet" href="css/alter5-colors.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chart-container {
            height: 400px;
        }
        .metric-card {
            background: linear-gradient(135deg, var(--alter-blue) 0%, var(--alter-blue-dark) 100%);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Analytics Dashboard</h1>
                    <span class="ml-3 px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                        Project ZURICH - Alter5
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <select id="projectFilter" class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <option value="all">Todos los proyectos</option>
                        <option value="senior_financing">Financiación Senior</option>
                        <option value="equity_investment">Inversión Equity</option>
                    </select>
                    <select id="timeFilter" class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        <option value="7">Últimos 7 días</option>
                        <option value="30" selected>Últimos 30 días</option>
                        <option value="90">Últimos 90 días</option>
                        <option value="all">Todo el tiempo</option>
                    </select>
                    <button id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Actualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Métricas principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Visitantes Únicos</h3>
                <p id="totalVisitors" class="text-3xl font-bold mt-2">-</p>
                <p id="visitorsChange" class="text-sm text-blue-100 mt-1">-</p>
            </div>
            
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Total Descargas</h3>
                <p id="totalDownloads" class="text-3xl font-bold mt-2">-</p>
                <p id="downloadsChange" class="text-sm text-blue-100 mt-1">-</p>
            </div>
            
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Solicitudes NDA</h3>
                <p id="totalNDARequests" class="text-3xl font-bold mt-2">-</p>
                <p id="ndaChange" class="text-sm text-blue-100 mt-1">-</p>
            </div>
            
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Tiempo Promedio</h3>
                <p id="avgTimeOnSite" class="text-3xl font-bold mt-2">-</p>
                <p id="timeChange" class="text-sm text-blue-100 mt-1">-</p>
            </div>
        </div>

        <!-- Gráficos principales -->
        <div class="stats-grid mb-8">
            <!-- Gráfico de descargas por tipo -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Descargas por Tipo de Archivo</h3>
                <div class="chart-container">
                    <canvas id="downloadsChart"></canvas>
                </div>
            </div>

            <!-- Gráfico de visitantes por tiempo -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Visitantes por Día</h3>
                <div class="chart-container">
                    <canvas id="visitorsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tablas detalladas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Top visitantes -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Visitantes Más Activos</h3>
                </div>
                <div class="p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2 text-sm font-medium text-gray-500">Visitante</th>
                                    <th class="text-left py-2 text-sm font-medium text-gray-500">Descargas</th>
                                    <th class="text-left py-2 text-sm font-medium text-gray-500">Tiempo</th>
                                    <th class="text-left py-2 text-sm font-medium text-gray-500">NDA</th>
                                </tr>
                            </thead>
                            <tbody id="topVisitorsTable">
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-gray-500">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Archivos más descargados -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Archivos Más Descargados</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-3" id="topFilesContainer">
                        <div class="text-center py-4 text-gray-500">Cargando datos...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Análisis detallado -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Análisis Detallado por Visitante</h3>
                <p class="text-sm text-gray-500 mt-1">Información completa de comportamiento e interacciones</p>
            </div>
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Email</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Empresa</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Proyecto</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Último Acceso</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Term Sheet</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Teaser</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Modelo Financiero</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">NDA</th>
                                <th class="text-left py-3 text-sm font-medium text-gray-500">Tiempo Total</th>
                            </tr>
                        </thead>
                        <tbody id="detailedAnalysisTable">
                            <tr>
                                <td colspan="9" class="text-center py-8 text-gray-500">Cargando análisis detallado...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Métricas en tiempo real -->
        <div class="mt-8 bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Actividad en Tiempo Real</h3>
                <p class="text-sm text-gray-500 mt-1">Visitantes activos y eventos recientes</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <p class="text-3xl font-bold text-green-600" id="activeVisitors">0</p>
                        <p class="text-sm text-gray-500">Visitantes Activos</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-blue-600" id="recentDownloads">0</p>
                        <p class="text-sm text-gray-500">Descargas (Última Hora)</p>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-bold text-purple-600" id="recentNDAs">0</p>
                        <p class="text-sm text-gray-500">NDAs (Última Hora)</p>
                    </div>
                </div>
                
                <!-- Log de eventos recientes -->
                <div class="mt-6">
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Eventos Recientes</h4>
                    <div class="space-y-2 max-h-48 overflow-y-auto" id="recentEventsLog">
                        <div class="text-sm text-gray-500">Cargando eventos...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        // Dashboard Analytics Controller
        class AnalyticsDashboard {
            constructor() {
                this.charts = {};
                this.refreshInterval = null;
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadDashboard();
                this.startRealTimeUpdates();
            }

            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadDashboard();
                });

                document.getElementById('projectFilter').addEventListener('change', () => {
                    this.loadDashboard();
                });

                document.getElementById('timeFilter').addEventListener('change', () => {
                    this.loadDashboard();
                });
            }

            async loadDashboard() {
                try {
                    await Promise.all([
                        this.loadMainMetrics(),
                        this.loadDownloadsChart(),
                        this.loadVisitorsChart(),
                        this.loadTopVisitors(),
                        this.loadTopFiles(),
                        this.loadDetailedAnalysis()
                    ]);
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                }
            }

            async loadMainMetrics() {
                try {
                    // Fetch real data from APIs
                    const [visitorsRes, analyticsRes] = await Promise.all([
                        fetch('/api/visitors'),
                        fetch('/api/analytics-real')
                    ]);
                    
                    const visitorsData = await visitorsRes.json();
                    const analyticsData = await analyticsRes.json();
                    
                    // Extract arrays from API responses
                    const visitors = visitorsData.data || visitorsData || [];
                    const analytics = analyticsData.data || analyticsData || [];
                    
                    // Calculate metrics
                    const totalVisitors = visitors.length;
                    const downloads = analytics.filter(e => e.event_type === 'download').length;
                    const ndaRequests = analytics.filter(e => e.event_type === 'nda_request').length;
                    
                    // Calculate average time on site from session_end events
                    const sessionEnds = analytics.filter(e => e.event_type === 'session_end');
                    const avgTime = sessionEnds.length > 0 
                        ? Math.floor(sessionEnds.reduce((sum, e) => sum + (e.event_data.total_time || 0), 0) / sessionEnds.length)
                        : 0;
                    const avgMinutes = Math.floor(avgTime / 60);
                    const avgSeconds = avgTime % 60;
                    
                    // Update UI
                    document.getElementById('totalVisitors').textContent = totalVisitors;
                    document.getElementById('visitorsChange').textContent = `${visitors.length} registrados`;
                    
                    document.getElementById('totalDownloads').textContent = downloads;
                    document.getElementById('downloadsChange').textContent = `${analytics.length} eventos totales`;
                    
                    document.getElementById('totalNDARequests').textContent = ndaRequests;
                    document.getElementById('ndaChange').textContent = ndaRequests > 0 ? 'Solicitudes activas' : 'Sin solicitudes';
                    
                    document.getElementById('avgTimeOnSite').textContent = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
                    document.getElementById('timeChange').textContent = `${sessionEnds.length} sesiones`;
                    
                    console.log('✅ Metrics loaded:', { totalVisitors, downloads, ndaRequests, avgTime });
                } catch (error) {
                    console.error('❌ Error loading metrics:', error);
                    // Show error state
                    document.getElementById('totalVisitors').textContent = '0';
                    document.getElementById('visitorsChange').textContent = 'Error cargando datos';
                }
            }

            async loadDownloadsChart() {
                try {
                    const analyticsRes = await fetch('/api/analytics-real');
                    const analyticsData = await analyticsRes.json();
                    const analytics = analyticsData.data || analyticsData || [];
                    
                    // Count downloads by type
                    const downloads = analytics.filter(e => e.event_type === 'download');
                    const downloadsByType = {};
                    
                    downloads.forEach(event => {
                        const fileType = event.event_data?.file_type || 'unknown';
                        downloadsByType[fileType] = (downloadsByType[fileType] || 0) + 1;
                    });
                    
                    const labels = Object.keys(downloadsByType);
                    const data = Object.values(downloadsByType);
                    const colors = ['var(--alter-blue)', 'var(--alter-green)', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4'];
                    
                    const ctx = document.getElementById('downloadsChart').getContext('2d');
                    
                    if (this.charts.downloads) {
                        this.charts.downloads.destroy();
                    }

                    this.charts.downloads = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels.length > 0 ? labels : ['Sin datos'],
                            datasets: [{
                                data: data.length > 0 ? data : [1],
                                backgroundColor: data.length > 0 ? colors.slice(0, labels.length) : ['#e5e7eb']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    
                    console.log('✅ Downloads chart loaded:', downloadsByType);
                } catch (error) {
                    console.error('❌ Error loading downloads chart:', error);
                }
            }

            async loadVisitorsChart() {
                const ctx = document.getElementById('visitorsChart').getContext('2d');
                
                if (this.charts.visitors) {
                    this.charts.visitors.destroy();
                }

                // Simulated data for the last 30 days
                const labels = [];
                const data = [];
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
                    data.push(Math.floor(Math.random() * 5) + 1);
                }

                this.charts.visitors = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Visitantes',
                            data: data,
                            borderColor: 'var(--alter-blue)',
                            backgroundColor: 'rgba(30, 58, 138, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            async loadTopVisitors() {
                try {
                    const [visitorsRes, analyticsRes] = await Promise.all([
                        fetch('/api/visitors'),
                        fetch('/api/analytics-real')
                    ]);
                    
                    const visitorsData = await visitorsRes.json();
                    const analyticsData = await analyticsRes.json();
                    
                    const visitors = visitorsData.data || visitorsData || [];
                    const analytics = analyticsData.data || analyticsData || [];
                    
                    // Calculate downloads per visitor
                    const visitorData = visitors.map(visitor => {
                        const downloads = analytics.filter(e => 
                            e.event_type === 'download' && e.visitor_token === visitor.token
                        ).length;
                        
                        const ndaRequests = analytics.filter(e => 
                            e.event_type === 'nda_request' && e.visitor_token === visitor.token
                        ).length;
                        
                        const lastAccess = visitor.last_access ? new Date(visitor.last_access) : null;
                        const timeStr = lastAccess ? lastAccess.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '-';
                        
                        return {
                            name: visitor.name || 'Anónimo',
                            email: visitor.email || '-',
                            company: visitor.company || '-',
                            downloads,
                            time: timeStr,
                            nda: ndaRequests > 0 ? 'Solicitado' : 'No'
                        };
                    });
                    
                    // Sort by downloads (descending)
                    visitorData.sort((a, b) => b.downloads - a.downloads);

                    const tbody = document.getElementById('topVisitorsTable');
                    if (visitorData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="py-6 text-center text-gray-500">No hay visitantes registrados</td></tr>';
                    } else {
                        tbody.innerHTML = visitorData.slice(0, 10).map(visitor => `
                            <tr class="border-b border-gray-100">
                                <td class="py-3">
                                    <div class="text-sm font-medium text-gray-900">${visitor.name}</div>
                                    <div class="text-sm text-gray-500">${visitor.company}</div>
                                </td>
                                <td class="py-3 text-sm text-gray-900">${visitor.downloads}</td>
                                <td class="py-3 text-sm text-gray-900">${visitor.time}</td>
                                <td class="py-3">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${visitor.nda === 'Solicitado' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        ${visitor.nda}
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                    }
                    
                    console.log('✅ Top visitors loaded:', visitorData.length);
                } catch (error) {
                    console.error('❌ Error loading top visitors:', error);
                    const tbody = document.getElementById('topVisitorsTable');
                    tbody.innerHTML = '<tr><td colspan="4" class="py-6 text-center text-red-500">Error cargando visitantes</td></tr>';
                }
            }

            async loadTopFiles() {
                try {
                    const analyticsRes = await fetch('/api/analytics-real');
                    const analyticsData = await analyticsRes.json();
                    const analytics = analyticsData.data || analyticsData || [];
                    
                    // Count downloads by file type
                    const downloads = analytics.filter(e => e.event_type === 'download');
                    const fileTypeMap = {
                        'teaser': 'Investment Teaser',
                        'term-sheet': 'Term Sheet',
                        'financial-model': 'Financial Model',
                        'nda': 'NDA Agreement',
                        'unknown': 'Other Documents'
                    };
                    
                    const downloadsByType = {};
                    downloads.forEach(event => {
                        const fileType = event.event_data?.file_type || 'unknown';
                        const displayName = fileTypeMap[fileType] || fileType;
                        if (!downloadsByType[fileType]) {
                            downloadsByType[fileType] = { name: displayName, count: 0, type: fileType };
                        }
                        downloadsByType[fileType].count++;
                    });
                    
                    // Convert to array and sort by count
                    const filesArray = Object.values(downloadsByType).sort((a, b) => b.count - a.count);
                    
                    const container = document.getElementById('topFilesContainer');
                    if (filesArray.length === 0) {
                        container.innerHTML = '<div class="p-3 text-center text-gray-500">No hay descargas registradas</div>';
                    } else {
                        container.innerHTML = filesArray.map(file => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-3" style="background-color: ${this.getFileTypeColor(file.type)}"></div>
                                    <span class="text-sm font-medium text-gray-900">${file.name}</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-600">${file.count}</span>
                            </div>
                        `).join('');
                    }
                    
                    console.log('✅ Top files loaded:', filesArray.length);
                } catch (error) {
                    console.error('❌ Error loading top files:', error);
                    const container = document.getElementById('topFilesContainer');
                    container.innerHTML = '<div class="p-3 text-center text-red-500">Error cargando archivos</div>';
                }
            }

            async loadDetailedAnalysis() {
                try {
                    const [visitorsRes, analyticsRes] = await Promise.all([
                        fetch('/api/visitors'),
                        fetch('/api/analytics-real')
                    ]);
                    
                    const visitorsData = await visitorsRes.json();
                    const analyticsData = await analyticsRes.json();
                    
                    const visitors = visitorsData.data || visitorsData || [];
                    const analytics = analyticsData.data || analyticsData || [];
                    
                    // Build detailed analysis per visitor
                    const analysis = visitors.map(visitor => {
                        const visitorEvents = analytics.filter(e => e.visitor_token === visitor.token);
                        
                        // Determine project based on last page visited
                        const pageVisits = visitorEvents.filter(e => e.event_type === 'page_visit');
                        let project = 'Unknown';
                        if (pageVisits.length > 0) {
                            const lastPage = pageVisits[pageVisits.length - 1].event_data?.page || '';
                            if (lastPage.includes('senior')) project = 'Senior';
                            else if (lastPage.includes('equity')) project = 'Equity';
                            else if (lastPage.includes('full')) project = 'Full Equity';
                            else project = 'Hub';
                        }
                        
                        // Count downloads by type
                        const downloads = visitorEvents.filter(e => e.event_type === 'download');
                        const termSheet = downloads.filter(d => d.event_data?.file_type === 'term-sheet').length;
                        const teaser = downloads.filter(d => d.event_data?.file_type === 'teaser').length;
                        const financial = downloads.filter(d => d.event_data?.file_type === 'financial-model').length;
                        
                        // Check NDA status
                        const ndaRequests = visitorEvents.filter(e => e.event_type === 'nda_request');
                        const nda = ndaRequests.length > 0 ? 'Solicitado' : 'No';
                        
                        // Calculate total time
                        const sessionEnds = visitorEvents.filter(e => e.event_type === 'session_end');
                        const totalSeconds = sessionEnds.reduce((sum, e) => sum + (e.event_data?.total_time || 0), 0);
                        const totalMinutes = Math.floor(totalSeconds / 60);
                        const totalSecs = totalSeconds % 60;
                        const totalTime = `${totalMinutes}:${totalSecs.toString().padStart(2, '0')}`;
                        
                        // Last access formatted
                        const lastAccess = visitor.last_access 
                            ? new Date(visitor.last_access).toLocaleString('es-ES', { 
                                year: 'numeric', month: '2-digit', day: '2-digit', 
                                hour: '2-digit', minute: '2-digit' 
                              })
                            : '-';
                        
                        return {
                            email: visitor.email || '-',
                            company: visitor.company || '-',
                            project,
                            lastAccess,
                            termSheet,
                            teaser,
                            financial,
                            nda,
                            totalTime
                        };
                    });
                    
                    // Sort by last access (most recent first)
                    analysis.sort((a, b) => {
                        if (a.lastAccess === '-') return 1;
                        if (b.lastAccess === '-') return -1;
                        return new Date(b.lastAccess) - new Date(a.lastAccess);
                    });

                    const tbody = document.getElementById('detailedAnalysisTable');
                    if (analysis.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="py-6 text-center text-gray-500">No hay datos de análisis disponibles</td></tr>';
                    } else {
                        tbody.innerHTML = analysis.map(row => `
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 text-sm text-gray-900">${row.email}</td>
                                <td class="py-3 text-sm text-gray-900">${row.company}</td>
                                <td class="py-3">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                        row.project === 'Senior' ? 'bg-blue-100 text-blue-800' : 
                                        row.project === 'Equity' ? 'bg-green-100 text-green-800' : 
                                        row.project === 'Full Equity' ? 'bg-purple-100 text-purple-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${row.project}
                                    </span>
                                </td>
                                <td class="py-3 text-sm text-gray-900">${row.lastAccess}</td>
                                <td class="py-3 text-sm text-center text-gray-900">${row.termSheet}</td>
                                <td class="py-3 text-sm text-center text-gray-900">${row.teaser}</td>
                                <td class="py-3 text-sm text-center text-gray-900">${row.financial}</td>
                                <td class="py-3">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${row.nda === 'Solicitado' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        ${row.nda}
                                    </span>
                                </td>
                                <td class="py-3 text-sm text-gray-900">${row.totalTime}</td>
                            </tr>
                        `).join('');
                    }
                    
                    console.log('✅ Detailed analysis loaded:', analysis.length);
                } catch (error) {
                    console.error('❌ Error loading detailed analysis:', error);
                    const tbody = document.getElementById('detailedAnalysisTable');
                    tbody.innerHTML = '<tr><td colspan="9" class="py-6 text-center text-red-500">Error cargando análisis detallado</td></tr>';
                }
            }

            startRealTimeUpdates() {
                // Actualizar métricas en tiempo real cada 30 segundos
                this.refreshInterval = setInterval(() => {
                    this.updateRealTimeMetrics();
                }, 30000);

                // Cargar métricas iniciales
                this.updateRealTimeMetrics();
            }

            updateRealTimeMetrics() {
                // Simular datos en tiempo real
                document.getElementById('activeVisitors').textContent = Math.floor(Math.random() * 8) + 1;
                document.getElementById('recentDownloads').textContent = Math.floor(Math.random() * 5);
                document.getElementById('recentNDAs').textContent = Math.floor(Math.random() * 3);

                // Log de eventos recientes
                this.updateRecentEvents();
            }

            updateRecentEvents() {
                const events = [
                    { time: '14:32', event: 'Descarga: Term Sheet', user: 'j.garcia@***.com' },
                    { time: '14:28', event: 'Solicitud NDA', user: 'm.lopez@***.com' },
                    { time: '14:15', event: 'Nuevo visitante', user: 'p.martin@***.com' },
                    { time: '14:02', event: 'Descarga: Teaser', user: 'a.rodriguez@***.com' }
                ];

                const container = document.getElementById('recentEventsLog');
                container.innerHTML = events.map(event => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-900">${event.event}</span>
                        <span class="text-gray-500">${event.time}</span>
                    </div>
                    <div class="text-xs text-gray-400 mb-2">${event.user}</div>
                `).join('');
            }

            getFileTypeColor(type) {
                const colors = {
                    'term-sheet': 'var(--alter-blue)',
                    'teaser': 'var(--alter-green)',
                    'financial-model': '#f59e0b',
                    'nda': '#8b5cf6'
                };
                return colors[type] || '#6b7280';
            }

            destroy() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
                
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
            }
        }

        // Inicializar dashboard
        let dashboardInstance;
        document.addEventListener('DOMContentLoaded', function() {
            dashboardInstance = new AnalyticsDashboard();
        });

        // Limpiar al salir
        window.addEventListener('beforeunload', () => {
            if (dashboardInstance) {
                dashboardInstance.destroy();
            }
        });
    </script>
</body>
</html><!-- sync -->
