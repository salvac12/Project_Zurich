<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Storage - Modelo Financiero</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .diagnostic-section { background: #f0f9ff; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .log { background: #000; color: #00ff00; padding: 15px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .test-btn { background: #059669; color: white; padding: 12px 20px; margin: 10px; border: none; border-radius: 6px; cursor: pointer; }
        .error { background: #fef2f2; border: 1px solid #fca5a5; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .success { background: #f0fdf4; border: 1px solid #86efac; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .warning { background: #fffbeb; border: 1px solid #fbbf24; padding: 15px; margin: 10px 0; border-radius: 6px; }
        pre { background: #f3f4f6; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico: ¬øPor qu√© no funciona la descarga del modelo financiero?</h1>
    
    <div class="log" id="debug-log"></div>

    <div class="diagnostic-section">
        <h3>üïµÔ∏è Diagn√≥stico Autom√°tico</h3>
        <button class="test-btn" onclick="runFullDiagnostic()">üîç Ejecutar Diagn√≥stico Completo</button>
        <button class="test-btn" onclick="checkLocalStorage()">üíæ Verificar LocalStorage</button>
        <button class="test-btn" onclick="testButtonConnection()">üîó Test Conexi√≥n Bot√≥n</button>
    </div>

    <div class="diagnostic-section">
        <h3>üß™ Test de Soluci√≥n</h3>
        <input type="file" id="test-model" accept=".xls,.xlsx,.xlsm,.pdf" style="margin: 10px 0; padding: 8px;">
        <button class="test-btn" onclick="uploadAndTestModel()">üìä Subir y Testear Modelo</button>
        <button class="test-btn" onclick="simulateRealClick()">üñ±Ô∏è Simular Click Real</button>
    </div>

    <div id="results"></div>

    <script src="js/document-manager.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            const debugLog = document.getElementById('debug-log');
            const div = document.createElement('div');
            
            if (type === 'error') {
                div.style.color = '#ff4444';
            } else if (type === 'success') {
                div.style.color = '#44ff44';
            } else if (type === 'warning') {
                div.style.color = '#ffff44';
            }
            
            div.textContent = logEntry;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = type;
            section.innerHTML = `<h4>${title}</h4><div>${content}</div>`;
            resultsDiv.appendChild(section);
        }

        function runFullDiagnostic() {
            log('üöÄ INICIANDO DIAGN√ìSTICO COMPLETO...', 'info');
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            // Test 1: DocumentManager availability
            log('üìã Test 1: DocumentManager', 'info');
            if (window.documentManager) {
                log('‚úÖ DocumentManager disponible', 'success');
                addResult('‚úÖ DocumentManager', 'Funciona correctamente', 'success');
            } else {
                log('‚ùå DocumentManager no disponible', 'error');
                addResult('‚ùå DocumentManager', 'NO disponible - ERROR CR√çTICO', 'error');
                return;
            }

            // Test 2: Check existing documents
            log('üìã Test 2: Documentos existentes', 'info');
            const summary = window.documentManager.getSummary();
            log('üìä Resumen: ' + JSON.stringify(summary, null, 2), 'info');
            
            const modelDocsES = window.documentManager.getDocuments('model', 'es');
            const modelDocsEN = window.documentManager.getDocuments('model', 'en');
            
            log(`üìÑ Modelos ES: ${modelDocsES.length}`, modelDocsES.length > 0 ? 'success' : 'warning');
            log(`üìÑ Modelos EN: ${modelDocsEN.length}`, modelDocsEN.length > 0 ? 'success' : 'warning');
            
            if (modelDocsES.length === 0 && modelDocsEN.length === 0) {
                addResult('‚ö†Ô∏è Problema Identificado', 'NO HAY MODELOS FINANCIEROS SUBIDOS<br>‚Ä¢ Ve a admin-docs.html<br>‚Ä¢ Sube un modelo financiero<br>‚Ä¢ Haz click en "Save All Changes"', 'warning');
            } else {
                addResult('‚úÖ Modelos Encontrados', `ES: ${modelDocsES.length}, EN: ${modelDocsEN.length}`, 'success');
                
                // Show model details
                if (modelDocsES.length > 0) {
                    const latest = window.documentManager.getLatestDocument('model', 'es');
                    log(`üìÑ √öltimo modelo ES: ${latest.name}`, 'success');
                    log(`üìÑ Tiene data: ${latest.data ? 'S√ç' : 'NO'}`, latest.data ? 'success' : 'error');
                }
            }

            // Test 3: Test button detection (simulate equity_investment.html)
            log('üìã Test 3: Detecci√≥n de bot√≥n', 'info');
            const testButton = document.createElement('button');
            testButton.className = 'doc-button';
            testButton.innerHTML = '<i class="fas fa-chart-line"></i> MODELO FINANCIERO';
            
            const buttonText = testButton.textContent.trim().toLowerCase();
            let documentType = '';
            
            if (buttonText.includes('modelo') || buttonText.includes('financiero') || buttonText.includes('financial')) {
                documentType = 'model';
            }
            
            if (documentType === 'model') {
                log('‚úÖ Detecci√≥n de bot√≥n funciona', 'success');
                addResult('‚úÖ Detecci√≥n de Bot√≥n', 'El bot√≥n "MODELO FINANCIERO" se detecta correctamente como tipo "model"', 'success');
            } else {
                log('‚ùå Falla detecci√≥n de bot√≥n', 'error');
                addResult('‚ùå Detecci√≥n de Bot√≥n', 'ERROR en detecci√≥n de tipo de documento', 'error');
            }

            // Test 4: Simulate download
            log('üìã Test 4: Simulaci√≥n descarga', 'info');
            if (modelDocsES.length > 0) {
                log('‚úÖ Se puede simular descarga', 'success');
                addResult('‚úÖ Descarga Funcional', 'Hay documentos para descargar', 'success');
            } else {
                log('‚ùå No se puede descargar (sin documentos)', 'warning');
                addResult('‚ùå Sin Documentos', 'La descarga fallar√≠a porque no hay modelos subidos', 'warning');
            }

            // Final diagnosis
            log('üìã DIAGN√ìSTICO COMPLETO', 'info');
            
            if (modelDocsES.length === 0 && modelDocsEN.length === 0) {
                addResult('üéØ DIAGN√ìSTICO FINAL', 
                    '<strong>PROBLEMA IDENTIFICADO:</strong><br>' +
                    '‚Ä¢ El sistema funciona correctamente<br>' +
                    '‚Ä¢ NO hay modelos financieros subidos<br>' +
                    '‚Ä¢ Soluci√≥n: Usar admin-docs.html para subir modelo<br>' +
                    '‚Ä¢ Importante: Hacer click en "Save All Changes"', 
                    'warning');
            } else {
                addResult('üéØ DIAGN√ìSTICO FINAL', 
                    'Sistema funciona correctamente. Los documentos est√°n disponibles para descarga.', 
                    'success');
            }
        }

        function checkLocalStorage() {
            log('üíæ Verificando LocalStorage...', 'info');
            
            const storageKey = 'project_zurich_documents';
            const stored = localStorage.getItem(storageKey);
            
            if (!stored) {
                log('‚ùå No hay datos en localStorage', 'error');
                addResult('‚ùå LocalStorage Vac√≠o', 'No hay documentos guardados en el navegador', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(stored);
                log('‚úÖ LocalStorage encontrado', 'success');
                
                const formatted = JSON.stringify(data, null, 2);
                addResult('üíæ Contenido LocalStorage', `<pre>${formatted}</pre>`, 'info');
                
                // Check specifically for model documents
                const modelES = data.model?.es?.length || 0;
                const modelEN = data.model?.en?.length || 0;
                
                log(`üìä Modelos en storage ES: ${modelES}, EN: ${modelEN}`, 'info');
                
            } catch (error) {
                log('‚ùå Error parseando localStorage: ' + error.message, 'error');
                addResult('‚ùå Error LocalStorage', 'Datos corruptos en localStorage', 'error');
            }
        }

        function testButtonConnection() {
            log('üîó Test conexi√≥n de bot√≥n...', 'info');
            
            // Create exact button as in equity_investment.html
            const button = document.createElement('button');
            button.className = 'doc-button';
            button.innerHTML = '<i class="fas fa-chart-line"></i> MODELO FINANCIERO';
            button.style.cssText = 'background: #1F3A8A; color: white; padding: 15px 25px; border: none; border-radius: 8px; margin: 10px;';
            
            // Add to page temporarily
            document.body.appendChild(button);
            
            // Test connection logic
            const buttonText = button.textContent.trim().toLowerCase();
            let documentType = '';
            
            if (buttonText.includes('modelo') || buttonText.includes('financiero') || buttonText.includes('financial')) {
                documentType = 'model';
            }
            
            if (documentType) {
                log(`‚úÖ Bot√≥n detectado como: ${documentType}`, 'success');
                
                // Add click handler
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    log('üñ±Ô∏è ¬°CLICK DETECTADO!', 'success');
                    testDownloadFunction('model', 'es');
                });
                
                button.textContent = 'TEST MODELO FINANCIERO (Click para probar)';
                addResult('üîó Bot√≥n de Prueba', 'Bot√≥n creado abajo. Haz click para probar.', 'success');
                
            } else {
                log('‚ùå No se detect√≥ tipo de documento', 'error');
                document.body.removeChild(button);
                addResult('‚ùå Error Conexi√≥n', 'No se pudo conectar el bot√≥n', 'error');
            }
        }

        function testDownloadFunction(type, language) {
            log('‚¨áÔ∏è Probando funci√≥n de descarga...', 'info');
            
            const latestDoc = window.documentManager.getLatestDocument(type, language);
            
            if (latestDoc && latestDoc.data) {
                log(`‚úÖ Documento encontrado: ${latestDoc.name}`, 'success');
                
                try {
                    const link = document.createElement('a');
                    link.href = latestDoc.data;
                    link.download = latestDoc.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    log('üéâ ¬°DESCARGA EXITOSA!', 'success');
                    addResult('üéâ Descarga Exitosa', `Se descarg√≥: ${latestDoc.name}`, 'success');
                    
                } catch (error) {
                    log(`‚ùå Error descarga: ${error.message}`, 'error');
                    addResult('‚ùå Error Descarga', error.message, 'error');
                }
                
            } else {
                log('‚ùå No hay documento para descargar', 'warning');
                addResult('‚ö†Ô∏è Sin Documentos', 'No hay modelo financiero para descargar. Sube uno primero.', 'warning');
            }
        }

        async function uploadAndTestModel() {
            const fileInput = document.getElementById('test-model');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå Selecciona un archivo', 'error');
                return;
            }
            
            log(`üì§ Subiendo modelo test: ${file.name}`, 'info');
            
            try {
                const result = await window.documentManager.addDocument('model', 'es', file);
                log(`‚úÖ Modelo subido: ${result.name}`, 'success');
                addResult('‚úÖ Subida Test', `Modelo subido: ${result.name}`, 'success');
                
                // Now test download
                setTimeout(() => {
                    testDownloadFunction('model', 'es');
                }, 500);
                
            } catch (error) {
                log(`‚ùå Error subiendo: ${error.message}`, 'error');
                addResult('‚ùå Error Subida', error.message, 'error');
            }
        }

        function simulateRealClick() {
            log('üñ±Ô∏è Simulando click real en equity_investment.html...', 'info');
            
            // This simulates exactly what happens when clicking the button in equity_investment.html
            const language = 'es';
            const type = 'model';
            
            log(`üéØ Simulando downloadRealDocument('${type}', '${language}')`, 'info');
            
            // Exact same logic as in document-manager.js downloadRealDocument function
            const latestDoc = window.documentManager.getLatestDocument(type, language);
            
            if (latestDoc && latestDoc.data) {
                log(`‚úÖ Encontrado: ${latestDoc.name}`, 'success');
                
                const link = document.createElement('a');
                link.href = latestDoc.data;
                link.download = latestDoc.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                log('üéâ ¬°Simulaci√≥n exitosa!', 'success');
                addResult('üéâ Simulaci√≥n Exitosa', 'El click funcionar√≠a correctamente', 'success');
                
            } else {
                log('‚ùå Simulaci√≥n: No hay documento', 'warning');
                
                // This is what happens in the real page - shows info message
                const message = `üìÑ Modelo Financiero no disponible a√∫n. Por favor contacte con nuestro equipo de inversi√≥n.`;
                log(`üí° Mensaje que se mostrar√≠a: ${message}`, 'warning');
                
                addResult('‚ö†Ô∏è Simulaci√≥n Real', 'Se mostrar√≠a mensaje: "Modelo Financiero no disponible a√∫n"<br>Esto confirma que NO hay modelo subido.', 'warning');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('‚úÖ Diagn√≥stico cargado', 'success');
            
            setTimeout(() => {
                log('üîç Ejecutando diagn√≥stico autom√°tico...', 'info');
                runFullDiagnostic();
            }, 1000);
        });
    </script>
</body>
</html>