<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix: Migrar Documentos al Sistema de Descarga</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .fix-section { background: #f0f9ff; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #3B82F6; }
        .log { background: #000; color: #00ff00; padding: 15px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .fix-btn { background: #DC2626; color: white; padding: 15px 25px; margin: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .test-btn { background: #059669; color: white; padding: 12px 20px; margin: 10px; border: none; border-radius: 6px; cursor: pointer; }
        .success { background: #10B981; color: white; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .error { background: #DC2626; color: white; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .warning { background: #F59E0B; color: white; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .upload-section { background: #f9fafb; padding: 15px; margin: 10px 0; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>üîß FIX: Migrar Documentos al Sistema de Descarga</h1>
    
    <div class="error">
        <strong>‚ùå PROBLEMA IDENTIFICADO:</strong><br>
        Los documentos est√°n en el admin panel pero NO en el DocumentManager.<br>
        Necesitas migrar manualmente los documentos al sistema de descarga.
    </div>
    
    <div class="log" id="fix-log"></div>

    <div class="fix-section">
        <h3>üö® SOLUCI√ìN R√ÅPIDA: Re-subir el Modelo Financiero</h3>
        <p><strong>PASO 1:</strong> Sube de nuevo tu archivo Excel del modelo financiero aqu√≠:</p>
        
        <div class="upload-section">
            <input type="file" id="model-file" accept=".xls,.xlsx,.xlsm,.pdf" style="margin: 10px 0; padding: 8px; width: 100%;">
            <button class="fix-btn" onclick="fixModelUpload()">üîß ARREGLAR: Subir Modelo al Sistema de Descarga</button>
        </div>
        
        <p><strong>PASO 2:</strong> Despu√©s de subir, testa la descarga:</p>
        <button class="test-btn" onclick="testDownloadAfterFix()">‚úÖ Test Descarga Despu√©s del Fix</button>
    </div>

    <div class="fix-section">
        <h3>üîç Verificar Estado Actual</h3>
        <button class="test-btn" onclick="checkCurrentState()">üìä Verificar Estado DocumentManager</button>
        <button class="test-btn" onclick="simulateRealDownload()">üñ±Ô∏è Simular Click Real en P√°gina</button>
    </div>

    <div class="fix-section">
        <h3>üìã Instrucciones Alternativas</h3>
        <div class="warning">
            <strong>Si el fix autom√°tico no funciona:</strong><br>
            1. Ve a <strong>admin-docs.html</strong><br>
            2. Elimina el modelo actual<br>
            3. Vuelve a subirlo<br>
            4. Haz click en <strong>"Save All Changes"</strong><br>
            5. Verifica que aparezca en la lista<br>
            6. Prueba la descarga en <strong>equity_investment.html</strong>
        </div>
    </div>

    <script src="js/document-manager.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            const debugLog = document.getElementById('fix-log');
            const div = document.createElement('div');
            
            if (type === 'error') {
                div.style.color = '#ff4444';
            } else if (type === 'success') {
                div.style.color = '#44ff44';
            } else if (type === 'warning') {
                div.style.color = '#ffff44';
            }
            
            div.textContent = logEntry;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        async function fixModelUpload() {
            const fileInput = document.getElementById('model-file');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå ERROR: Selecciona el archivo del modelo financiero primero', 'error');
                alert('Por favor, selecciona tu archivo Excel del modelo financiero (.xlsx o .xlsm)');
                return;
            }
            
            log('üîß INICIANDO FIX: Subiendo modelo al DocumentManager...', 'info');
            log(`üìÑ Archivo: ${file.name} (${file.size} bytes, tipo: ${file.type})`, 'info');
            
            try {
                // Clear any existing model documents first
                log('üóëÔ∏è Limpiando modelos existentes...', 'info');
                const existingModels = window.documentManager.getDocuments('model', 'es');
                existingModels.forEach(doc => {
                    window.documentManager.removeDocument('model', 'es', doc.id);
                });
                
                // Add the new model document
                const result = await window.documentManager.addDocument('model', 'es', file, {
                    uploadedAt: new Date().toISOString(),
                    fixedUpload: true,
                    source: 'manual_fix'
                });
                
                log(`‚úÖ FIX EXITOSO: ${result.name} subido al DocumentManager`, 'success');
                log(`üìä ID del documento: ${result.id}`, 'success');
                log(`üìä Tama√±o data: ${result.data ? result.data.length : 0} caracteres`, 'success');
                
                // Verify it was stored correctly
                const verification = window.documentManager.getLatestDocument('model', 'es');
                if (verification && verification.data) {
                    log('‚úÖ VERIFICACI√ìN EXITOSA: El modelo est√° ahora disponible para descarga', 'success');
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success';
                    successDiv.innerHTML = `
                        <strong>üéâ ¬°FIX COMPLETADO EXITOSAMENTE!</strong><br>
                        El modelo financiero "${result.name}" est√° ahora disponible para descarga.<br>
                        Ve a <strong>equity_investment.html</strong> y haz click en "MODELO FINANCIERO"
                    `;
                    document.body.appendChild(successDiv);
                    
                } else {
                    throw new Error('El documento se subi√≥ pero no se puede verificar');
                }
                
            } catch (error) {
                log(`‚ùå ERROR EN FIX: ${error.message}`, 'error');
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <strong>‚ùå Error en el fix:</strong><br>
                    ${error.message}<br><br>
                    <strong>Soluci√≥n alternativa:</strong><br>
                    Ve a admin-docs.html, elimina y vuelve a subir el modelo.
                `;
                document.body.appendChild(errorDiv);
            }
        }

        function checkCurrentState() {
            log('üîç VERIFICANDO estado actual del DocumentManager...', 'info');
            
            if (!window.documentManager) {
                log('‚ùå DocumentManager no disponible', 'error');
                return;
            }
            
            // Check all document types
            const summary = window.documentManager.getSummary();
            log('üìä Resumen completo:', 'info');
            log(JSON.stringify(summary, null, 2), 'info');
            
            // Specifically check model documents
            const modelES = window.documentManager.getDocuments('model', 'es');
            const modelEN = window.documentManager.getDocuments('model', 'en');
            
            log(`üìÑ Modelos ES: ${modelES.length}`, modelES.length > 0 ? 'success' : 'error');
            log(`üìÑ Modelos EN: ${modelEN.length}`, modelEN.length > 0 ? 'success' : 'info');
            
            if (modelES.length > 0) {
                modelES.forEach((doc, i) => {
                    log(`  [${i}] ${doc.name} - ID: ${doc.id}`, 'success');
                    log(`      Uploaded: ${doc.uploaded}`, 'info');
                    log(`      Has data: ${doc.data ? 'YES' : 'NO'}`, doc.data ? 'success' : 'error');
                });
                
                const latest = window.documentManager.getLatestDocument('model', 'es');
                log(`üìÑ √öltimo modelo: ${latest.name}`, 'success');
            } else {
                log('‚ùå NO HAY MODELOS EN ESPA√ëOL - Este es el problema', 'error');
            }
        }

        function testDownloadAfterFix() {
            log('‚úÖ TESTEANDO descarga despu√©s del fix...', 'info');
            
            const latestDoc = window.documentManager.getLatestDocument('model', 'es');
            
            if (latestDoc && latestDoc.data) {
                log(`üìÑ Documento encontrado: ${latestDoc.name}`, 'success');
                
                try {
                    const link = document.createElement('a');
                    link.href = latestDoc.data;
                    link.download = latestDoc.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    log('üéâ ¬°DESCARGA EXITOSA! El fix funcion√≥ correctamente', 'success');
                    
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success';
                    successDiv.innerHTML = `
                        <strong>üéâ ¬°√âXITO TOTAL!</strong><br>
                        El modelo financiero se descarg√≥ correctamente.<br>
                        Ahora ve a <strong>equity_investment.html</strong> y verifica que funciona all√≠ tambi√©n.
                    `;
                    document.body.appendChild(successDiv);
                    
                } catch (error) {
                    log(`‚ùå Error en descarga: ${error.message}`, 'error');
                }
                
            } else {
                log('‚ùå NO hay documento para descargar. Necesitas hacer el fix primero.', 'error');
            }
        }

        function simulateRealDownload() {
            log('üñ±Ô∏è SIMULANDO click real en equity_investment.html...', 'info');
            
            // This is exactly what happens when clicking the button
            const type = 'model';
            const language = 'es';
            
            const latestDoc = window.documentManager.getLatestDocument(type, language);
            
            if (latestDoc && latestDoc.data) {
                log(`‚úÖ SIMULACI√ìN: Se descargar√≠a "${latestDoc.name}"`, 'success');
                log('‚úÖ El bot√≥n en equity_investment.html FUNCIONAR√çA correctamente', 'success');
            } else {
                log('‚ùå SIMULACI√ìN: Se mostrar√≠a "Modelo Financiero no disponible a√∫n"', 'error');
                log('‚ùå El bot√≥n en equity_investment.html NO funciona (este es el problema actual)', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß Fix tool cargado', 'success');
            log('üí° Para arreglar el problema: sube tu archivo Excel arriba y haz click en ARREGLAR', 'info');
            
            setTimeout(() => {
                checkCurrentState();
            }, 1000);
        });
    </script>
</body>
</html>