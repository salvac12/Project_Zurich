<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Button Detection - Focused</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { background: #f0f9ff; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .log { background: #000; color: #00ff00; padding: 15px; font-family: monospace; max-height: 400px; overflow-y: auto; margin: 10px 0; }
        .doc-button { background: linear-gradient(135deg, #1F3A8A 0%, #3B82F6 100%); color: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; margin: 10px; }
        .test-btn { background: #059669; color: white; padding: 12px 20px; margin: 10px; border: none; border-radius: 6px; cursor: pointer; }
        .upload-section { background: #f9fafb; padding: 15px; margin: 10px 0; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>ğŸ” Test Focused: Button Detection & Download</h1>
    
    <div class="log" id="debug-log"></div>

    <div class="test-section">
        <h3>ğŸ“¤ Paso 1: Cargar Modelo Financiero</h3>
        <div class="upload-section">
            <input type="file" id="model-file" accept=".xls,.xlsx,.xlsm,.pdf" style="margin: 10px 0; padding: 8px;">
            <button class="test-btn" onclick="uploadTestModel()">ğŸ“Š Cargar Modelo Test</button>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ¯ Paso 2: BotÃ³n de Prueba</h3>
        <p>BotÃ³n exacto como en equity_investment.html:</p>
        <button class="doc-button" id="test-modelo-btn">
            <i class="fas fa-chart-line"></i>
            MODELO FINANCIERO
        </button>
    </div>

    <div class="test-section">
        <h3>ğŸ”§ Paso 3: Tests Detallados</h3>
        <button class="test-btn" onclick="testDetection()">ğŸ•µï¸ Test DetecciÃ³n</button>
        <button class="test-btn" onclick="testConnection()">ğŸ”— Test ConexiÃ³n</button>
        <button class="test-btn" onclick="testDirectDownload()">â¬‡ï¸ Test Descarga Directa</button>
    </div>

    <script src="js/document-manager.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            const debugLog = document.getElementById('debug-log');
            const div = document.createElement('div');
            
            if (type === 'error') {
                div.style.color = '#ff4444';
            } else if (type === 'success') {
                div.style.color = '#44ff44';
            } else if (type === 'warning') {
                div.style.color = '#ffff44';
            }
            
            div.textContent = logEntry;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        async function uploadTestModel() {
            const fileInput = document.getElementById('model-file');
            const file = fileInput.files[0];
            
            if (!file) {
                log('âŒ Por favor selecciona un archivo', 'error');
                return;
            }
            
            log(`ğŸ“¤ Subiendo: ${file.name} (${file.type})`, 'info');
            
            try {
                const result = await window.documentManager.addDocument('model', 'es', file, {
                    uploadedAt: new Date().toISOString(),
                    testUpload: true
                });
                
                log(`âœ… Archivo subido: ${result.name} (ID: ${result.id})`, 'success');
                
                // Verify it was stored
                const docs = window.documentManager.getDocuments('model', 'es');
                log(`ğŸ“Š Total modelos ES: ${docs.length}`, 'info');
                
                const latest = window.documentManager.getLatestDocument('model', 'es');
                if (latest) {
                    log(`ğŸ“„ Ãšltimo modelo: ${latest.name}`, 'success');
                    log(`ğŸ“„ Tiene data: ${latest.data ? 'SÃ (' + latest.data.substring(0, 50) + '...)' : 'NO'}`, latest.data ? 'success' : 'error');
                }
                
            } catch (error) {
                log(`âŒ Error subiendo: ${error.message}`, 'error');
            }
        }

        function testDetection() {
            log('ğŸ•µï¸ INICIANDO TEST DE DETECCIÃ“N...', 'info');
            
            // Test the exact button
            const button = document.getElementById('test-modelo-btn');
            
            if (!button) {
                log('âŒ BotÃ³n no encontrado', 'error');
                return;
            }
            
            log('âœ… BotÃ³n encontrado', 'success');
            
            // Test text content
            const fullText = button.textContent;
            const trimmedText = fullText.trim();
            const lowerText = trimmedText.toLowerCase();
            
            log(`ğŸ“ Texto completo: "${fullText}"`, 'info');
            log(`ğŸ“ Texto trimmed: "${trimmedText}"`, 'info');
            log(`ğŸ“ Texto lower: "${lowerText}"`, 'info');
            
            // Test detection logic exactly as in document-manager.js
            let documentType = '';
            
            if (lowerText.includes('teaser')) {
                documentType = 'teaser';
                log('ğŸ¯ Detectado como: teaser', 'info');
            } else if (lowerText.includes('term-sheet') || lowerText.includes('term sheet')) {
                documentType = 'termsheet';
                log('ğŸ¯ Detectado como: termsheet', 'info');
            } else if (lowerText.includes('modelo') || lowerText.includes('financiero') || lowerText.includes('financial')) {
                documentType = 'model';
                log('ğŸ¯ Detectado como: model', 'success');
            }
            
            if (!documentType) {
                log('âŒ NO SE DETECTÃ“ TIPO DE DOCUMENTO', 'error');
            } else {
                log(`âœ… Tipo detectado correctamente: ${documentType}`, 'success');
            }
            
            // Test individual keyword detection
            log(`ğŸ” Contiene 'modelo': ${lowerText.includes('modelo')}`, 'info');
            log(`ğŸ” Contiene 'financiero': ${lowerText.includes('financiero')}`, 'info');
            log(`ğŸ” Contiene 'financial': ${lowerText.includes('financial')}`, 'info');
        }

        function testConnection() {
            log('ğŸ”— INICIANDO TEST DE CONEXIÃ“N...', 'info');
            
            const button = document.getElementById('test-modelo-btn');
            
            if (!button) {
                log('âŒ BotÃ³n no encontrado', 'error');
                return;
            }
            
            // Remove any existing listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Add the exact same logic as connectExistingButtons
            const buttonText = newButton.textContent.trim().toLowerCase();
            let documentType = '';
            
            if (buttonText.includes('modelo') || buttonText.includes('financiero') || buttonText.includes('financial')) {
                documentType = 'model';
            }
            
            if (documentType) {
                log(`ğŸ”— Conectando botÃ³n para tipo: ${documentType}`, 'info');
                
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    log(`ğŸ–±ï¸ Â¡CLICK DETECTADO EN BOTÃ“N ${documentType}!`, 'success');
                    downloadRealDocument(documentType, 'es');
                });
                
                log(`âœ… Event listener aÃ±adido`, 'success');
                
                // Update ID for future reference
                newButton.id = 'test-modelo-btn';
                
            } else {
                log('âŒ No se detectÃ³ tipo de documento para conexiÃ³n', 'error');
            }
        }

        function downloadRealDocument(type, language) {
            log(`ğŸ¯ INICIANDO DESCARGA: ${type} (${language})`, 'info');
            
            // Step 1: Check DocumentManager
            if (!window.documentManager) {
                log('âŒ DocumentManager no disponible', 'error');
                return;
            }
            log('âœ… DocumentManager OK', 'success');
            
            // Step 2: Get latest document
            const latestDoc = window.documentManager.getLatestDocument(type, language);
            
            if (!latestDoc) {
                log(`âŒ No hay documento ${type} en ${language}`, 'error');
                
                // Show available documents
                const allDocs = window.documentManager.getDocuments(type, language);
                log(`ğŸ’¡ Documentos disponibles ${type}/${language}: ${allDocs.length}`, 'warning');
                
                if (allDocs.length === 0) {
                    log('ğŸ’¡ SOLUCIÃ“N: Primero sube un modelo financiero usando el botÃ³n de arriba', 'warning');
                }
                return;
            }
            
            log(`âœ… Documento encontrado: ${latestDoc.name}`, 'success');
            
            // Step 3: Check data
            if (!latestDoc.data) {
                log('âŒ El documento no tiene data', 'error');
                return;
            }
            
            log(`âœ… Documento tiene data (${latestDoc.data.length} chars)`, 'success');
            
            // Step 4: Download
            try {
                const link = document.createElement('a');
                link.href = latestDoc.data;
                link.download = latestDoc.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                log(`ğŸ‰ Â¡DESCARGA EXITOSA: ${latestDoc.name}!`, 'success');
                
            } catch (error) {
                log(`âŒ Error en descarga: ${error.message}`, 'error');
            }
        }

        function testDirectDownload() {
            log('â¬‡ï¸ TEST DESCARGA DIRECTA...', 'info');
            downloadRealDocument('model', 'es');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('âœ… PÃ¡gina cargada', 'success');
            
            setTimeout(() => {
                if (window.documentManager) {
                    log('âœ… DocumentManager inicializado', 'success');
                    
                    // Check current state
                    const modelDocs = window.documentManager.getDocuments('model', 'es');
                    log(`ğŸ“Š Modelos ES existentes: ${modelDocs.length}`, modelDocs.length > 0 ? 'success' : 'info');
                    
                    if (modelDocs.length > 0) {
                        log('ğŸ’¡ Ya hay modelos cargados. Puedes probar la descarga directamente.', 'info');
                    } else {
                        log('ğŸ’¡ No hay modelos. Sube uno primero.', 'warning');
                    }
                    
                } else {
                    log('âŒ DocumentManager NO inicializado', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>