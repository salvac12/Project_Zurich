<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modelo Simple</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .doc-button { background: #1F3A8A; color: white; padding: 15px 25px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; }
        .log { background: #000; color: #0f0; padding: 15px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .test-btn { background: #10B981; color: white; padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Test Simple: Modelo Financiero</h1>
    
    <div class="log" id="log"></div>

    <input type="file" id="file-input" accept=".xls,.xlsx,.xlsm,.pdf">
    <button class="test-btn" onclick="uploadModel()">Cargar Modelo</button>
    <button class="test-btn" onclick="checkModel()">Verificar Modelo</button>
    
    <!-- Bot√≥n exacto de la p√°gina original -->
    <button class="doc-button">
        MODELO FINANCIERO
    </button>

    <script src="js/document-manager.js"></script>
    <script>
        function log(msg) {
            const logEl = document.getElementById('log');
            logEl.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function uploadModel() {
            const file = document.getElementById('file-input').files[0];
            if (!file) {
                log('‚ùå No file selected');
                return;
            }
            
            log(`üì§ Uploading: ${file.name}`);
            
            window.documentManager.addDocument('model', 'es', file)
                .then(result => {
                    log(`‚úÖ Upload success: ${result.name} (ID: ${result.id})`);
                    
                    // Immediately check if we can retrieve it
                    const retrieved = window.documentManager.getLatestDocument('model', 'es');
                    if (retrieved) {
                        log(`‚úÖ Retrieved successfully: ${retrieved.name}`);
                        log(`‚úÖ Has data: ${retrieved.data ? 'YES' : 'NO'} (${retrieved.data ? retrieved.data.length + ' chars' : 'empty'})`);
                    } else {
                        log(`‚ùå Could not retrieve after upload`);
                    }
                })
                .catch(error => {
                    log(`‚ùå Upload error: ${error.message}`);
                });
        }

        function checkModel() {
            const docs = window.documentManager.getDocuments('model', 'es');
            log(`üìä Model documents count: ${docs.length}`);
            
            if (docs.length > 0) {
                docs.forEach((doc, i) => {
                    log(`  [${i}] ${doc.name} - ${doc.id} - hasData: ${doc.data ? 'YES' : 'NO'}`);
                });
                
                const latest = window.documentManager.getLatestDocument('model', 'es');
                log(`üéØ Latest: ${latest ? latest.name : 'NONE'}`);
            }
        }

        function testDownload() {
            log('‚¨áÔ∏è Testing download...');
            
            const latest = window.documentManager.getLatestDocument('model', 'es');
            if (!latest) {
                log('‚ùå No model document found');
                return;
            }
            
            if (!latest.data) {
                log('‚ùå Document has no data');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.href = latest.data;
                link.download = latest.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('‚úÖ Download triggered');
            } catch (error) {
                log(`‚ùå Download error: ${error.message}`);
            }
        }

        // Test button text detection
        function testButtonDetection() {
            const button = document.querySelector('.doc-button');
            const buttonText = button.textContent.trim().toLowerCase();
            
            log(`üîç Button text: "${button.textContent.trim()}"`);
            log(`üîç Lowercase: "${buttonText}"`);
            log(`üîç Contains 'modelo': ${buttonText.includes('modelo')}`);
            log(`üîç Contains 'financiero': ${buttonText.includes('financiero')}`);
            
            // Test the exact detection logic
            let documentType = '';
            if (buttonText.includes('teaser')) {
                documentType = 'teaser';
            } else if (buttonText.includes('term-sheet') || buttonText.includes('term sheet')) {
                documentType = 'termsheet';
            } else if (buttonText.includes('modelo') || buttonText.includes('financiero') || buttonText.includes('financial')) {
                documentType = 'model';
            }
            
            log(`üéØ Detected type: "${documentType}"`);
            
            if (documentType === 'model') {
                log('‚úÖ Button detection WORKS');
                
                // Connect the button
                button.addEventListener('click', function() {
                    log('üñ±Ô∏è Button clicked!');
                    testDownload();
                });
                log('‚úÖ Button connected to download');
            } else {
                log('‚ùå Button detection FAILED');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page loaded');
            
            setTimeout(() => {
                if (window.documentManager) {
                    log('‚úÖ DocumentManager available');
                    testButtonDetection();
                } else {
                    log('‚ùå DocumentManager not available');
                }
            }, 500);
        });
    </script>
</body>
</html>